# Implementation Plan: Customizable Lens Prompts for Conversation Summarization

## Overview
Add a flexible "lens" system that allows users to customize how conversation summaries are generated by providing reusable, customizable prompts that focus the summarization on different aspects (e.g., technical insights, action items, key decisions, learning points).

## Current Implementation Analysis

### Current Summarization Flow
1. **Content Extraction** (`content.js`): Extracts conversation turns from claude.ai
2. **Export Initiation** (`popup.js`): User selects Notion page and clicks export
3. **Summarization** (`background.js`): Each turn is sent to Anthropic API with a fixed prompt:
   ```
   You are summarizing a conversation turn between a user and an AI assistant. 
   Provide two summaries:
   1. A one-sentence summary (max 150 characters)
   2. A one-paragraph summary (3-5 sentences)
   ```
4. **Notion Export** (`background.js`): Creates toggle blocks with summaries and full conversation

### Current Storage Structure
- `chrome.storage.local` stores:
  - `anthropicApiKey`: API key for Claude
  - `notionToken`: Notion integration token
  - `selectedPageId`: Last selected Notion page
  - `selectedPageTitle`: Last selected page title
  - `exportProgress`: Current export progress data

## Feature Requirements

### User Experience
1. **Lens Management Page** (similar to settings.html)
   - Navigate to lens management from popup
   - List all saved lens prompts
   - Add new lens prompts
   - Edit existing lens prompts
   - Delete lens prompts (with confirmation)
   - Set default lens (radio button selection)
   
2. **Export Page Integration** (popup.html)
   - Dropdown to select lens for current export
   - Shows currently selected lens name
   - Dropdown options:
     - List all saved lens prompts
     - "Add New Lens..." option at bottom (navigates to lens management)
   - Default lens pre-selected but changeable per export

3. **Default Lens Prompts** (shipped with extension)
   - **General Summary** (default): Current behavior
   - **Technical Focus**: Emphasize technical details, code, architecture
   - **Action Items**: Extract tasks, decisions, next steps
   - **Learning Points**: Key takeaways and insights
   - **Problem-Solving**: Focus on problems discussed and solutions

## Technical Implementation

### Phase 1: Data Model & Storage (2-3 hours)

#### 1.1 Define Lens Data Structure
```javascript
// Lens object structure
{
  id: string,           // UUID v4
  name: string,         // User-friendly name (e.g., "Technical Focus")
  prompt: string,       // The custom prompt template
  isDefault: boolean,   // Whether this is the default lens
  isBuiltIn: boolean,   // Whether this is a pre-installed lens (non-deletable)
  createdAt: number,    // Timestamp
  updatedAt: number     // Timestamp
}
```

#### 1.2 Storage Schema Updates
```javascript
// chrome.storage.local additions
{
  lenses: [            // Array of lens objects
    {
      id: 'built-in-general',
      name: 'General Summary',
      prompt: 'You are summarizing a conversation turn...',
      isDefault: true,
      isBuiltIn: true,
      createdAt: 1234567890,
      updatedAt: 1234567890
    },
    // ... more lenses
  ],
  selectedLensId: string  // Currently selected lens for next export
}
```

#### 1.3 Create `lensManager.js` utility
- `initializeDefaultLenses()`: Set up built-in lenses on first run
- `getLenses()`: Retrieve all lenses
- `getLens(id)`: Get specific lens
- `getDefaultLens()`: Get the default lens
- `saveLens(lens)`: Add or update lens
- `deleteLens(id)`: Remove lens (prevent deletion of built-in)
- `setDefaultLens(id)`: Mark a lens as default
- `validateLens(lens)`: Ensure lens has required fields

**Files to create:**
- `utils/lensManager.js`

### Phase 2: Lens Management UI (3-4 hours)

#### 2.1 Create Lens Management Page

**Files to create:**
- `lenses.html`: Lens management page UI
- `lenses.js`: Lens management page logic

**lenses.html Structure:**
```html
<div class="header">
  <button id="backBtn">←</button>
  <h1>Summarization Lenses</h1>
</div>

<div class="lens-list">
  <!-- Dynamically populated list of lenses -->
  <div class="lens-item">
    <div class="lens-header">
      <input type="radio" name="default" />
      <span class="lens-name">General Summary</span>
      <span class="built-in-badge">Built-in</span>
    </div>
    <div class="lens-preview">Preview of prompt...</div>
    <div class="lens-actions">
      <button class="edit-btn">Edit</button>
      <button class="delete-btn" disabled>Delete</button>
    </div>
  </div>
</div>

<button id="addLensBtn">+ Add New Lens</button>

<!-- Modal for add/edit lens -->
<div class="modal" id="lensModal">
  <div class="modal-content">
    <h2 id="modalTitle">Add New Lens</h2>
    <label>Lens Name</label>
    <input type="text" id="lensName" />
    
    <label>Summarization Prompt</label>
    <textarea id="lensPrompt" rows="10"></textarea>
    
    <div class="help-text">
      Use {USER_CONTENT} and {ASSISTANT_CONTENT} as placeholders
      for the conversation content in your prompt.
    </div>
    
    <div class="modal-actions">
      <button id="cancelBtn">Cancel</button>
      <button id="saveLensBtn">Save Lens</button>
    </div>
  </div>
</div>
```

**lenses.js Features:**
- Load and display all lenses
- Handle default lens selection (radio buttons)
- Add new lens (open modal)
- Edit lens (populate modal with existing data)
- Delete lens (with confirmation dialog)
- Validate lens before saving
- Show built-in badge and disable delete for built-in lenses

#### 2.2 Styling
- Match existing design system from settings.html
- Modal overlay for add/edit
- Hover states for lens items
- Disabled state for built-in lens delete buttons
- Radio buttons for default selection

### Phase 3: Popup UI Integration (2 hours)

#### 3.1 Update popup.html

Add lens selector between page selection and export button:

```html
<div class="section">
  <label>Summarization Lens</label>
  <div class="lens-selector">
    <select id="lensSelect">
      <option value="built-in-general">General Summary</option>
      <option value="built-in-technical">Technical Focus</option>
      <!-- ... dynamically loaded options ... -->
      <option value="__add__">➕ Add New Lens...</option>
    </select>
    <button id="manageLensesBtn" class="icon-btn" title="Manage Lenses">⚙️</button>
  </div>
</div>
```

**Styling:**
```css
.lens-selector {
  display: flex;
  gap: 8px;
}

.lens-selector select {
  flex: 1;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 13px;
}

.icon-btn {
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 16px;
}
```

#### 3.2 Update popup.js

**New functionality:**
- Load lenses on popup open and populate dropdown
- Save selected lens to storage when changed
- Restore previously selected lens on popup open
- Handle "Add New Lens..." option (open lens management)
- Handle manage lenses button click

**Code additions:**
```javascript
// Load lenses and populate dropdown
async function loadLensSelector() {
  const { lenses, selectedLensId } = await chrome.storage.local.get([
    'lenses', 
    'selectedLensId'
  ]);
  
  const lensSelect = document.getElementById('lensSelect');
  lensSelect.innerHTML = '';
  
  // Add all lenses
  lenses.forEach(lens => {
    const option = document.createElement('option');
    option.value = lens.id;
    option.textContent = lens.name;
    lensSelect.appendChild(option);
  });
  
  // Add "Add New" option
  const addOption = document.createElement('option');
  addOption.value = '__add__';
  addOption.textContent = '➕ Add New Lens...';
  lensSelect.appendChild(addOption);
  
  // Set selected lens (default or previously selected)
  if (selectedLensId) {
    lensSelect.value = selectedLensId;
  } else {
    const defaultLens = lenses.find(l => l.isDefault);
    lensSelect.value = defaultLens?.id || lenses[0]?.id;
  }
}

// Handle lens selection
lensSelect.addEventListener('change', async (e) => {
  if (e.target.value === '__add__') {
    // Open lens management page
    chrome.windows.create({
      url: 'lenses.html',
      type: 'popup',
      width: 600,
      height: 600
    });
    // Reset to previous selection
    loadLensSelector();
  } else {
    // Save selection
    await chrome.storage.local.set({ selectedLensId: e.target.value });
  }
});

// Manage lenses button
manageLensesBtn.addEventListener('click', () => {
  chrome.windows.create({
    url: 'lenses.html',
    type: 'popup',
    width: 600,
    height: 600
  });
});
```

### Phase 4: Backend Integration (2 hours)

#### 4.1 Update background.js

Modify `handleSummarization()` to accept and use custom lens prompt:

```javascript
async function handleSummarization(turnData, apiKey, lensPrompt) {
  const { user, assistant, turnNumber } = turnData;
  
  // Replace placeholders in lens prompt
  let prompt = lensPrompt
    .replace(/{USER_CONTENT}/g, user)
    .replace(/{ASSISTANT_CONTENT}/g, assistant);
  
  // Rest of existing logic...
}
```

#### 4.2 Update handleFullExport()

Retrieve selected lens and pass to summarization:

```javascript
async function handleFullExport(exportData) {
  const { turns, chatTitle, conversationUrl, apiKey, notionToken, pageId } = exportData;
  
  // Get selected lens
  const { selectedLensId, lenses } = await chrome.storage.local.get([
    'selectedLensId', 
    'lenses'
  ]);
  
  const selectedLens = lenses.find(l => l.id === selectedLensId) || 
                      lenses.find(l => l.isDefault) ||
                      lenses[0];
  
  const lensPrompt = selectedLens.prompt;
  
  // Update summarization calls
  for (let i = 0; i < turns.length; i++) {
    const turn = turns[i];
    try {
      const summary = await handleSummarization(turn, apiKey, lensPrompt);
      // ... rest of logic
    }
  }
}
```

#### 4.3 Update popup.js export initiation

Pass selected lens to background worker:

```javascript
exportBtn.addEventListener('click', async () => {
  // ... existing validation ...
  
  // Get selected lens
  const { selectedLensId } = await chrome.storage.local.get(['selectedLensId']);
  
  // Send to background worker
  chrome.runtime.sendMessage({
    action: 'startExport',
    data: {
      turns,
      chatTitle,
      conversationUrl,
      apiKey,
      notionToken: notionTokenValue,
      pageId: selectedPageId,
      lensId: selectedLensId  // NEW
    }
  });
});
```

### Phase 5: Built-in Lenses & Initialization (1-2 hours)

#### 5.1 Create Default Lens Prompts

In `lensManager.js`:

```javascript
const BUILT_IN_LENSES = [
  {
    id: 'built-in-general',
    name: 'General Summary',
    prompt: `You are summarizing a conversation turn between a user and an AI assistant. Provide two summaries:

1. A one-sentence summary (max 150 characters)
2. A one-paragraph summary (3-5 sentences)

Format your response as JSON:
{
  "oneLine": "...",
  "paragraph": "..."
}

Conversation turn to summarize:
User: {USER_CONTENT}

Assistant{ASSISTANT_CONTENT}`,
    isDefault: true,
    isBuiltIn: true,
    createdAt: Date.now(),
    updatedAt: Date.now()
  },
  {
    id: 'built-in-technical',
    name: 'Technical Focus',
    prompt: `You are summarizing a technical conversation between a user and an AI assistant, with emphasis on technical details, code, architecture, and implementation specifics.

Provide two summaries:
1. A one-sentence summary (max 150 characters) highlighting the main technical topic
2. A one-paragraph summary (3-5 sentences) that includes:
   - Technical concepts discussed
   - Code or implementation details
   - Architectural decisions
   - Technologies or tools mentioned

Format your response as JSON:
{
  "oneLine": "...",
  "paragraph": "..."
}

Conversation turn:
User: {USER_CONTENT}
User: {USER_CONTENT}Assistant: {ASSISTANT_CONTENT}`,
    isDefault: false,
    isBuiltIn: true,
    createdAt: Date.now(),
    updatedAt: Date.now()
  },
  {
    id: 'built-in-action-items',
    name: 'Action Items',
    prompt: `You are extracting action items, decisions, and next steps from a conversation between a user and an AI assistant.

Provide two summaries focusing on actionable content:
1. A one-sentence summary (max 150 characters) of the main action or decision
2. A one-paragraph summary (3-5 sentences) that includes:
   - Specific tasks or action items mentioned
   - Decisions that were made
   - Next steps or follow-up actions
   - Deadlines or timelines if mentioned
   - Responsibilities or assignments

Format your response as JSON:
{
  "oneLine": "...",
  "paragraph": "..."
}

Conversation turn:
User: {USER_CONTENT}